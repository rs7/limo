<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>LIMO</title>
    <script src="//vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>
    <script src="remote.js" type="text/javascript"></script>
    <script src="util.js" type="text/javascript"></script>
    <script src="templates.js" type="text/javascript"></script>
    <script src="bundle.js" type="text/javascript"></script>
    <script type="text/javascript">
        var runParams;

        var user;

        //vk request

        function getPhotosRequest(user, cb) {
            doPublicVKRequest('photos.get', {
                owner_id: user,
                album_id: 'profile',
                rev: 1,
                count: 10
            }, cb);
        }

        function processGetPhotosResponse(response) {
            return response.items.map(function (photo) {
                return photo.id;
            });
        }

        getPhotos = async.seq(getPhotosRequest, async.asyncify(processGetPhotosResponse));

        //--

        function getLikersRequest(user, photo, cb) {
            doPublicVKRequest('likes.getList', {
                type: 'photo',
                owner_id: user,
                item_id: photo,
                count: 100
            }, cb);
        }

        function processGetLikersResponse(response) {
            return (response.count > 100) ? [-100] : response.items;
        }

        getLikers = async.seq(getLikersRequest, async.asyncify(processGetLikersResponse));
        
        //--

        function getUsersRequest(users, cb) {
            doPublicVKRequest('users.get', {
                user_ids: users.join(),
                fields: ['photo_50','domain'].join(),
                name_case: 'dat',
                count: 1000
            }, cb);
        }

        function processGetUsersResponse(response) {
            return createFieldMap(response, 'id');
        }

        getUsers = async.seq(getUsersRequest, async.asyncify(processGetUsersResponse));

        //--

        function getPhotosDataRequest(user, photos, cb) {
            var photosFullIds = photos.map(function (photo) {
                return user + '_' + photo;
            });

            doPublicVKRequest('photos.getById', {
                photos: photosFullIds
            }, cb);
        }

        function processGetPhotosDataResponse(response) {
            return createFieldMap(response, 'id');
        }

        getPhotosData = async.seq(getPhotosDataRequest, async.asyncify(processGetPhotosDataResponse));

        //create data object

        function createPhotoObject(photo, likers) {
            return {
                photo_id: photo,
                likers: likers
            };
        }

        function createDataObject(user, photos) {
            return {
                user_id: user,
                photos: photos
            };
        }

        //

        function getPhotoObject(user, photo, cb) {
            async.waterfall([
                async.apply(getLikers, user, photo),
                async.apply(async.asyncify(createPhotoObject), photo)
            ], cb);
        }

        function getPhotoListObject(user, cb) {
            var getUserPhotos = async.apply(getPhotos, user);
            var getUserPhotoObject = async.apply(getPhotoObject, user);

            async.waterfall([
                getUserPhotos,
                function (photos, cb) {
                    async.concat(photos, getUserPhotoObject, cb);
                }
            ], cb);
        }

        function getVKData(user, cb) {
            async.waterfall([
                async.apply(getPhotoListObject, user),
                async.apply(async.asyncify(createDataObject), user)
            ], cb);
        }

        //server request

        function getServerData(data, cb) {
            doServerRequest(data, cb);
        }

        //

        function fillItems(user, items, cb) {
            if (items.length == 0) {
                return cb(null, []);
            }

            var photos = [];
            var users = [];

            items.forEach(function (item) {
                photos.push(item.photo);
                users.push(item.user);
            });

            async.parallel({
                photos: async.apply(getPhotosData, user, photos),
                users: async.apply(getUsers, users)
            }, function (error, response) {
                if (error) {
                    return cb(error);
                }

                var result = items.map(function (item) {
                    return {
                        photo: response.photos[item.photo],
                        user: response.users[item.user],
                        date: new Date(item.date)
                    };
                });

                console.log(response, result);

                cb(null, result);
            })
        }

        function load() {
            showLoading();
            clearItems();
            async.waterfall([
                async.apply(getVKData, user),
                getServerData,
                function (response, cb) {
                    async.waterfall([
                        async.apply(fillItems, user, response.items),
                        function (items, cb) {
                            showItems(items, new Date(response.last_seen));
                            cb();
                        }
                    ], cb);
                }
            ], function () {
                hideLoading();
            });
        }

        //----

        $(document).ready(init);

        function showLoading() {
            $('#feed_new_posts').css('display', 'none');
            $('#feed_progress').css('display', 'block');
        }

        function hideLoading() {
            $('#feed_progress').css('display', 'none');
            $('#feed_new_posts').css('display', 'block');
        }

        function clearItems() {
            var unreadBar = $('#feedback_unread_bar');
            unreadBar.css('display', 'none');
            unreadBar.prevAll().remove();
            unreadBar.nextAll().remove();

            $('#feed_empty').css('display', 'block');
        }

        function showItems(items, lastSeen) {
            items.sort(function(a, b) {
                return b.date - a.date;
            });

            if (items.length > 0) {
                $('#feed_empty').css('display', 'none');
            }

            var unreadItems = items.filter(function (item) {
                return item.date >= lastSeen;
            });

            var readItems = items.filter(function (item) {
                return item.date < lastSeen;
            });

            var unreadBar = $('#feedback_unread_bar');

            if (unreadItems.length > 0 && readItems.length > 0) {
                unreadBar.css('display', 'block');
            }

            unreadItems.forEach(function (item) {
                unreadBar.before(Template.item(item));
            });

            readItems.forEach(function (item) {
                unreadBar.after(Template.item(item));
            });
        }

        function init() {
            runParams = getUrlVars();

            user = parseInt(runParams.viewer_id);

            console.log('runParams:', runParams);

            Handlebars.registerHelper("timestamp", function (date) {
                 return Math.floor(date.getTime() / 1000);
            });

            Handlebars.registerHelper("date", function (date) {
                return printDate(date);
            });

            $('#page_wrap').load('page.html', null, function () {
                $('#feed_new_posts').click(function () {
                    load();
                });

                $('#show_more_link').css('display', 'none');

                load();
            });
        }
    </script>
    <script src="//vk.com/js/al/feed.js?410" type="text/javascript"></script>
    <script src="//vk.com/js/al/page.js?941" type="text/javascript"></script>
    <link rel='stylesheet' type='text/css' href='//vk.com/css/al/common.css?511'>
    <link rel='stylesheet' type='text/css' href='//vk.com/css/al/feed.css?239'>
    <link rel='stylesheet' type='text/css' href='//vk.com/css/al/page.css?789'>
    <link rel='stylesheet' type='text/css' href='vk-override.css'>
</head>
<body>
    <div id="page_wrap"></div>
</body>
</html>
